using System;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ImageTagger
{
    public partial class MainForm : Form
    {
        private readonly ImageProcessingService processingService = new();
        private CancellationTokenSource? cancellationTokenSource;
        private Task? processingTask;

        public MainForm()
        {
            InitializeComponent();
            ConfigureEventHandlers();
        }

        private void ConfigureEventHandlers()
        {
            processingService.ProgressChanged += ProcessingService_ProgressChanged;
            processingService.ProcessingComplete += ProcessingService_ProcessingComplete;
        }


        private void ProcessingService_ProgressChanged(object? sender, ProcessingProgressEventArgs e)
        {
            if (InvokeRequired)
            {
                Invoke(() => ProcessingService_ProgressChanged(sender, e));
                return;
            }

            // Update progress
            lblStatus.Text = e.Status;
            if (e.TotalFiles > 0)
            {
                progressBar.Visible = true;
                progressBar.Maximum = e.TotalFiles;
                progressBar.Value = Math.Min(e.ProcessedFiles, e.TotalFiles);
                lblProgress.Text = $"{e.ProcessedFiles} / {e.TotalFiles}";
            }
            else
            {
                progressBar.Visible = false;
                lblProgress.Text = $"{e.ProcessedFiles}";
            }

            // Update status color
            if (e.IsError)
            {
                lblStatus.ForeColor = Color.Red;
            }
            else
            {
                lblStatus.ForeColor = Color.Green;
            }

            // Update image preview
            if (!string.IsNullOrEmpty(e.ImagePath) && File.Exists(e.ImagePath))
            {
                try
                {
                    if (pictureBox.Image != null)
                    {
                        var image = pictureBox.Image;
                        pictureBox.Image = null;

                        image.Dispose();
                    }

                    pictureBox.Image = new Bitmap(e.ImagePath);
                }
                catch
                {
                    // Image couldn't be loaded, continue
                }
            }

            // Update tags display
            if (e.Tags != null && e.Tags.Length > 0)
            {
                lstTags.Items.Clear();
                foreach (var tag in e.Tags)
                {
                    lstTags.Items.Add(tag);
                }
            }

            // Update comment
            if (!string.IsNullOrEmpty(e.Comment))
            {
                txtComment.Text = $"{e.Comment}";
            }

            lblCurrentFile.Visible = true;
            lblCurrentFile.Text = $"Current File: {e.CurrentFile}";

            // Log to list box
            if (!string.IsNullOrEmpty(e.Status))
            {
                LogEntry(e.CurrentFile, e.Status, e.Comment);
            }
        }

        private void ProcessingService_ProcessingComplete(object? sender, ProcessingCompleteEventArgs e)
        {
            if (InvokeRequired)
            {
                Invoke(() => ProcessingService_ProcessingComplete(sender, e));
                return;
            }

            btnSelectFolder.Enabled = true;
            btnAbort.Enabled = false;
            btnStart.Enabled = true;
            groupProcessingMode.Enabled = true;
            chkMarkClassificationErrors.Enabled = true;
            lblProgress.Text = $"Complete: {e.ProcessedFiles} / {e.TotalFiles}";
            progressBar.Visible = false;
            lblCurrentFile.Visible = false;
            MessageBox.Show($"Processing complete!\nProcessed: {e.ProcessedFiles} / {e.TotalFiles}");
        }

        private void LogEntry(string fileName, string status, string comment)
        {
            lstLog.Items.Add($"[{DateTime.Now:HH:mm:ss}] {fileName}: {status} - {comment}");
            lstLog.TopIndex = Math.Max(0, lstLog.Items.Count - 1);
        }

        private void btnSelectFolder_Click(object sender, EventArgs e)
        {
            using (var dialog = new FolderBrowserDialog())
            {
                dialog.Description = "Select the folder containing images to process";
                if (dialog.ShowDialog() == DialogResult.OK)
                {
                    txtFolderPath.Text = dialog.SelectedPath;
                    btnStart.Enabled = !string.IsNullOrWhiteSpace(dialog.SelectedPath);
                }
            }
        }

        private void btnStart_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtFolderPath.Text))
            {
                MessageBox.Show("Please select a folder first.");
                return;
            }

            if (!Directory.Exists(txtFolderPath.Text))
            {
                MessageBox.Show("The selected folder does not exist.");
                return;
            }

            btnSelectFolder.Enabled = false;
            btnStart.Enabled = false;
            btnAbort.Enabled = true;
            lstLog.Items.Clear();
            progressBar.Value = 0;
            lblProgress.Text = "0 / 0";
            lblStatus.Text = "Processing...";
            lblStatus.ForeColor = Color.Black;
            groupProcessingMode.Enabled = false;
            chkMarkClassificationErrors.Enabled = false;

            cancellationTokenSource = new CancellationTokenSource();

            ImageProcessingService.ProcessingModeEnum processingMode;

            if (optAllFiles.Checked)
            {
                processingMode = ImageProcessingService.ProcessingModeEnum.ProcessAll;
            }
            else if (optSkipTaggedFiles.Checked)
            {
                processingMode = ImageProcessingService.ProcessingModeEnum.SkipTagged;
            }
            else
            {
                processingMode = ImageProcessingService.ProcessingModeEnum.ProcessClassificationErrorsOnly;
            }

            processingTask = processingService.StartProcessing(txtFolderPath.Text, processingMode, chkMarkClassificationErrors.Checked, cancellationTokenSource);
        }

        private void btnAbort_Click(object sender, EventArgs e)
        {
            cancellationTokenSource?.Cancel();
            btnAbort.Enabled = false;
            lblStatus.Text = "Aborting...";
            lblStatus.ForeColor = Color.Orange;
        }
    }
}
